# Stats é¡µé¢ & Links åˆ—è¡¨é‡æ„è®¾è®¡

> æ—¥æœŸ: 2026-01-31
> çŠ¶æ€: å·²ç¡®è®¤

## æ¦‚è¿°

ä¿®å¤ Devices/Browsers æ˜¾ç¤º "Unknown" çš„ bugï¼Œå¹¶å°† Stats é¡µé¢å’Œ Links åˆ—è¡¨é‡æ„ä¸º Bitly é£æ ¼ã€‚

## é—®é¢˜

1. **Devices/Browsers æ˜¾ç¤º "Unknown"**ï¼šåç«¯ `click_flusher.go` ç¡¬ç¼–ç  `DeviceType: "unknown"`ï¼Œæ²¡æœ‰è§£æ User-Agent
2. **Stats é¡µé¢è®¾è®¡ç®€é™‹**ï¼šç›®å‰æ˜¯ç®€å•åˆ—è¡¨ï¼ŒBitly ç”¨ç¯å½¢å›¾å±•ç¤º
3. **Links åˆ—è¡¨è®¾è®¡å·®å¼‚å¤§**ï¼šç›®å‰æ˜¯è¡¨æ ¼ï¼ŒBitly æ˜¯å¡ç‰‡å¼å¸ƒå±€

## æŠ€æœ¯é€‰å‹

- **User-Agent è§£æ**: `github.com/mssola/useragent`
- **GeoIP**: MaxMind GeoLite2 + `github.com/oschwald/geoip2-golang`
- **å›¾è¡¨åº“**: Recharts

---

## Part 1ï¼šåç«¯ - User-Agent è§£æ

**ç›®æ ‡**ï¼šä¿®å¤ Devices/Browsers æ˜¾ç¤º "Unknown" çš„é—®é¢˜

**ä¿®æ”¹ä½ç½®**ï¼š`backend/internal/worker/click_flusher.go`

**æ–¹æ¡ˆ**ï¼š
1. å¼•å…¥ Go çš„ User-Agent è§£æåº“ `github.com/mssola/useragent`
2. åœ¨ `flushClicks()` æ–¹æ³•ä¸­ï¼Œå½“ä» Redis è¯»å– click event åï¼Œè§£æ `UserAgent` å­—æ®µ
3. æå–å¹¶å¡«å……ï¼š
   - `DeviceType`: desktop / mobile / tablet / unknown
   - `Browser`: Chrome / Safari / Firefox / Edge / ç­‰

**ä»£ç æ”¹åŠ¨**ï¼š
```go
// click_flusher.go
import "github.com/mssola/useragent"

// åœ¨æ„å»º Click å¯¹è±¡æ—¶
ua := useragent.New(event.UserAgent)
deviceType := "desktop"
if ua.Mobile() {
    deviceType = "mobile"
} else if ua.Tablet() {
    deviceType = "tablet"
}
browserName, _ := ua.Browser()

click := model.Click{
    DeviceType: deviceType,
    Browser:    browserName,
    // ... å…¶ä»–å­—æ®µ
}
```

---

## Part 2ï¼šåç«¯ - GeoIP åœ°ç†å®šä½ + å­˜å‚¨çœŸå® IP

**ç›®æ ‡**ï¼šå¡«å…… `country`ã€`city` å­—æ®µï¼Œå¹¶å­˜å‚¨çœŸå® IP

**æ•°æ®åº“æ”¹åŠ¨**ï¼š
```sql
-- åœ¨ clicks è¡¨æ·»åŠ å­—æ®µ
ALTER TABLE clicks ADD COLUMN ip_address VARCHAR(45) AFTER ip_hash;
-- VARCHAR(45) æ”¯æŒ IPv6 æœ€é•¿æ ¼å¼
```

**æ•°æ®æµæ”¹åŠ¨**ï¼š
```
å½“å‰: redirect handler â†’ hash IP â†’ å­˜å…¥ Redis (åªæœ‰ ip_hash)
æ”¹å: redirect handler â†’ å­˜å…¥ Redis (ip_hash + ip_address) â†’ flusher æŸ¥ GeoIP â†’ å…¨éƒ¨å­˜å…¥æ•°æ®åº“
```

**ä¿®æ”¹ä½ç½®**ï¼š
- `backend/internal/model/click.go` - æ·»åŠ  `IPAddress` å­—æ®µ
- `backend/internal/handler/redirect.go` - åŒæ—¶ä¼ é€’ `ip_hash` å’Œ `ip_address`
- `backend/internal/worker/click_flusher.go` - ç”¨ `ip_address` æŸ¥ GeoIPï¼Œå­˜å…¥æ•°æ®åº“
- `backend/migrations/` - æ·»åŠ æ–°è¿ç§»æ–‡ä»¶

**é…ç½®**ï¼šåœ¨ `config.yaml` æ·»åŠ  GeoIP æ•°æ®åº“è·¯å¾„

---

## Part 3ï¼šå‰ç«¯ - Stats é¡µé¢å¸ƒå±€

**ç›®æ ‡**ï¼šå¤åˆ» Bitly çš„ Stats é¡µé¢è®¾è®¡

**é¡µé¢ç»“æ„**ï¼ˆä»ä¸Šåˆ°ä¸‹ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Back to list                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é“¾æ¥ä¿¡æ¯å¡]                                         â”‚
â”‚  æ ‡é¢˜ / çŸ­é“¾æ¥ (å¤åˆ¶æŒ‰é’®) / åŸå§‹ URL / åˆ›å»ºæ—¥æœŸ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Engagements over time              [æ—¥æœŸèŒƒå›´é€‰æ‹©å™¨]   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ â–ˆ ï¼ˆæŸ±çŠ¶å›¾ï¼‰               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Locations                    [Countries] [Cities]   â”‚
â”‚  1. CN â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  500  45%              â”‚
â”‚  2. US â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            200  18%              â”‚
â”‚  ...                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Referrers                â”‚ Devices                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  Direct   50%  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  Mobile  60%  â”‚
â”‚  â”‚ ç¯å½¢ â”‚  Google   30%  â”‚  â”‚ ç¯å½¢ â”‚  Desktop 35% â”‚
â”‚  â”‚  å›¾  â”‚  Twitter  20%  â”‚  â”‚  å›¾  â”‚  Tablet   5% â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜                â”‚  â””â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Browsers                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”  Chrome  45%  â”‚  Safari  30%  â”‚ Firefox 15%â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç»„ä»¶æ‹†åˆ†**ï¼š
- `LinkInfoCard` - é¡¶éƒ¨é“¾æ¥ä¿¡æ¯
- `EngagementsChart` - æŸ±çŠ¶å›¾ï¼ˆRecharts BarChartï¼‰
- `LocationsChart` - æ°´å¹³æ¡å½¢å›¾ + å›½å®¶/åŸå¸‚åˆ‡æ¢
- `DonutChart` - å¯å¤ç”¨çš„ç¯å½¢å›¾ç»„ä»¶
- `StatsSection` - é€šç”¨ç»Ÿè®¡åŒºå—å®¹å™¨

---

## Part 4ï¼šå‰ç«¯ - Links åˆ—è¡¨é¡µé¢

**ç›®æ ‡**ï¼šå¤åˆ» Bitly çš„ Links åˆ—è¡¨è®¾è®¡

**é¡µé¢ç»“æ„**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Bitly Links                          [Create link]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ğŸ” Search links] [ğŸ“… Filter by date] [âš™ Add filters]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜ 0 selected  Export  Hide  Tag    [â‰¡][âŠŸ][âŠ] Show: Active â–¼â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ â—‹  Link Title                    [âœ][â†—][ğŸ“Š][â‹¯]â”‚ â”‚
â”‚ â”‚      bit.ly/abc123 ğŸ“‹                           â”‚ â”‚
â”‚ â”‚      â†© https://original-url.com/...             â”‚ â”‚
â”‚ â”‚      ğŸ“Š Click data  ğŸ“… Jan 31, 2026  ğŸ· No tags â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ â—‹  Another Link                  [âœ][â†—][ğŸ“Š][â‹¯]â”‚ â”‚
â”‚ â”‚      ...                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åŠŸèƒ½æ¸…å•**ï¼š
- **æœç´¢**ï¼šæŒ‰æ ‡é¢˜ã€çŸ­é“¾æ¥ã€åŸå§‹ URL æœç´¢
- **æ—¥æœŸç­›é€‰**ï¼šé€‰æ‹©æ—¥æœŸèŒƒå›´
- **çŠ¶æ€ç­›é€‰**ï¼šActive / Inactive / All
- **æ‰¹é‡æ“ä½œ**ï¼šå‹¾é€‰åå¯ Export / Hide / Delete
- **è§†å›¾åˆ‡æ¢**ï¼šåˆ—è¡¨(é»˜è®¤) / ç´§å‡‘ / ç½‘æ ¼
- **å•é¡¹æ“ä½œ**ï¼šç¼–è¾‘ã€åˆ†äº«ã€æŸ¥çœ‹ç»Ÿè®¡ã€æ›´å¤šèœå•

**ç»„ä»¶æ‹†åˆ†**ï¼š
- `LinksToolbar` - æœç´¢ + ç­›é€‰ + è§†å›¾åˆ‡æ¢
- `LinkCard` - å•ä¸ªé“¾æ¥å¡ç‰‡
- `LinkCardCompact` - ç´§å‡‘è§†å›¾
- `LinkCardGrid` - ç½‘æ ¼è§†å›¾
- `BulkActions` - æ‰¹é‡æ“ä½œæ 

---

## Part 5ï¼šåç«¯ - API æ”¹åŠ¨

**ç›®æ ‡**ï¼šæ”¯æŒæ–°çš„å‰ç«¯åŠŸèƒ½

**æ–°å¢/ä¿®æ”¹çš„ API**ï¼š

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| GET | `/api/links` | æ·»åŠ æŸ¥è¯¢å‚æ•°æ”¯æŒ |
| GET | `/api/links/:id/stats` | æ·»åŠ  locations æ•°æ® |
| PATCH | `/api/links/:id` | æ›´æ–°é“¾æ¥ï¼ˆæ ‡é¢˜ç­‰ï¼‰ |
| POST | `/api/links/bulk` | æ‰¹é‡æ“ä½œ |

**`GET /api/links` æ–°å¢å‚æ•°**ï¼š
```
?search=keyword      # æœç´¢
&status=active       # çŠ¶æ€ç­›é€‰ (active/inactive/all)
&from=2026-01-01     # å¼€å§‹æ—¥æœŸ
&to=2026-01-31       # ç»“æŸæ—¥æœŸ
&sort=created_desc   # æ’åº
&page=1&limit=20     # åˆ†é¡µ
```

**`GET /api/links/:id/stats` å“åº”æ–°å¢**ï¼š
```json
{
  "locations": {
    "countries": [
      {"code": "CN", "name": "China", "clicks": 500, "percentage": 45}
    ],
    "cities": [
      {"name": "Shanghai", "country": "CN", "clicks": 200, "percentage": 18}
    ]
  }
}
```

**`POST /api/links/bulk` è¯·æ±‚**ï¼š
```json
{
  "action": "delete",  // delete / export / hide
  "ids": [1, 2, 3]
}
```

---

## Part 6ï¼šå®ç°è®¡åˆ’

**é˜¶æ®µåˆ’åˆ†**ï¼ˆå¯å¹¶è¡Œï¼‰ï¼š

**åç«¯å·¥ä½œ**ï¼š
1. User-Agent è§£æ - å¼•å…¥åº“ï¼Œä¿®æ”¹ click_flusher
2. GeoIP é›†æˆ - å¼•å…¥åº“ï¼Œé…ç½®æ•°æ®åº“è·¯å¾„ï¼Œä¿®æ”¹ click_flusher
3. æ•°æ®åº“è¿ç§» - æ·»åŠ  `ip_address` å­—æ®µ
4. API æ”¹åŠ¨ - links æœç´¢/ç­›é€‰ã€stats locationsã€æ‰¹é‡æ“ä½œ

**å‰ç«¯å·¥ä½œ**ï¼š
1. å®‰è£… Recharts
2. åˆ›å»ºé€šç”¨å›¾è¡¨ç»„ä»¶ï¼ˆDonutChartã€BarChartï¼‰
3. é‡æ„ Stats é¡µé¢
4. é‡æ„ Links åˆ—è¡¨é¡µé¢
5. æ·»åŠ æœç´¢ã€ç­›é€‰ã€æ‰¹é‡æ“ä½œåŠŸèƒ½

**æ–‡ä»¶æ”¹åŠ¨æ¸…å•**ï¼š

| ä½ç½® | æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|------|
| åç«¯ | `go.mod` | æ·»åŠ  useragentã€geoip2 ä¾èµ– |
| åç«¯ | `internal/model/click.go` | æ·»åŠ  IPAddress å­—æ®µ |
| åç«¯ | `internal/handler/redirect.go` | ä¼ é€’çœŸå® IP |
| åç«¯ | `internal/worker/click_flusher.go` | UA è§£æ + GeoIP |
| åç«¯ | `internal/handler/links.go` | æœç´¢/ç­›é€‰å‚æ•° |
| åç«¯ | `internal/handler/stats.go` | æ·»åŠ  locations |
| åç«¯ | `internal/repository/click_repo.go` | locations æŸ¥è¯¢ |
| åç«¯ | `migrations/` | æ–°è¿ç§»æ–‡ä»¶ |
| å‰ç«¯ | `package.json` | æ·»åŠ  recharts |
| å‰ç«¯ | `components/charts/` | DonutChart, BarChart ç­‰ |
| å‰ç«¯ | `app/dashboard/links/[id]/stats/` | é‡æ„ Stats é¡µ |
| å‰ç«¯ | `components/links/` | LinkCard, LinksToolbar ç­‰ |
| å‰ç«¯ | `app/dashboard/links/` | é‡æ„ Links åˆ—è¡¨ |
